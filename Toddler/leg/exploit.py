from pwn import *
from time import sleep

# connect
shell = ssh("leg", "pwnable.kr", 2222, "guest")
proc = shell.shell()

# caculate key1
"""
(gdb) disass key1
Dump of assembler code for function key1:
   0x00008cd4 <+0>: push    {r11}
   0x00008cd8 <+4>: add r11, sp, #0
   0x00008cdc <+8>: mov r3, pc          ; fetch
   0x00008ce0 <+12>:    mov r0, r3      ; decode
   0x00008ce4 <+16>:    sub sp, r11, #0 ; execute(real pc value)
   0x00008ce8 <+20>:    pop {r11} 
   0x00008cec <+24>:    bx  lr  
End of assembler dump.
"""
key1 = 0x00008ce4

# caculate key2
"""
(gdb) disass key2
Dump of assembler code for function key2:
   0x00008cf0 <+0>: push    {r11}
   0x00008cf4 <+4>: add r11, sp, #0
   0x00008cf8 <+8>: push    {r6}
   0x00008cfc <+12>:    add r6, pc, #1
   0x00008d00 <+16>:    bx  r6
   0x00008d04 <+20>:    mov r3, pc     ; fetch
   0x00008d06 <+22>:    adds    r3, #4 ; decode(pc + 4)
   0x00008d08 <+24>:    push    {r3}   ; execute(real pc value)
   0x00008d0a <+26>:    pop {pc}
   0x00008d0c <+28>:    pop {r6}
   0x00008d10 <+32>:    mov r0, r3
   0x00008d14 <+36>:    sub sp, r11, #0
   0x00008d18 <+40>:    pop {r11}
   0x00008d1c <+44>:    bx  lr
End of assembler dump.
"""
key2 = 0x00008d08 + 4

# calculate key3
"""
(gdb) disass key3
Dump of assembler code for function key3:
   0x00008d20 <+0>: push    {r11}
   0x00008d24 <+4>: add r11, sp, #0
   0x00008d28 <+8>: mov r3, lr          ; find lr
   0x00008d2c <+12>:    mov r0, r3
   0x00008d30 <+16>:    sub sp, r11, #0
   0x00008d34 <+20>:    pop {r11}
   0x00008d38 <+24>:    bx  lr
End of assembler dump.

(gdb) disass main
Dump of assembler code for function main:
   0x00008d3c <+0>: push    {r4, r11, lr}
...
   0x00008d7c <+64>:    bl  0x8d20 <key3>
   0x00008d80 <+68>:    mov r3, r0     ; lr of key3()
   0x00008d84 <+72>:    add r2, r4, r3
...
End of assembler dump.
"""
key3 = 0x00008d80 

# receive flag
proc.recvuntil("$")
proc.sendline("./leg")
print proc.recvuntil("Daddy has very strong arm! : "), 

# send key
proc.sendline(str(key1+key2+key3))

# receive flag
print proc.recvuntil("$")

# disconnect
proc.close()
shell.close()
